<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Linux内存管理:slab原理以及buddy伙伴系统 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1 为什么有了Buddy(伙伴系统)还需要slab?1.1 什么是伙伴系统？Linux内核中使用伙伴系统（buddy system）算法以页为单位管理内存，进行内存分配。 1.1.1 伙伴系统思想它把所有的空闲页放到11个链表中，每个链表分别管理大小为1，2，4，8，16，32，64，128，256，512，1024个页的内存块。当系统需要分配内存时，就可以从buddy系统中获取。 1.2 伙伴系">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内存管理:slab原理以及buddy伙伴系统">
<meta property="og:url" content="http://example.com/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 为什么有了Buddy(伙伴系统)还需要slab?1.1 什么是伙伴系统？Linux内核中使用伙伴系统（buddy system）算法以页为单位管理内存，进行内存分配。 1.1.1 伙伴系统思想它把所有的空闲页放到11个链表中，每个链表分别管理大小为1，2，4，8，16，32，64，128，256，512，1024个页的内存块。当系统需要分配内存时，就可以从buddy系统中获取。 1.2 伙伴系">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/image-20221012160254149.png">
<meta property="article:published_time" content="2022-10-12T07:54:40.000Z">
<meta property="article:modified_time" content="2022-10-31T10:06:13.228Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/image-20221012160254149.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Linux内存管理-slab原理以及buddy伙伴系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2022-10-12T07:54:40.000Z" itemprop="datePublished">2022-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux内存管理:slab原理以及buddy伙伴系统
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-为什么有了Buddy-伙伴系统-还需要slab"><a href="#1-为什么有了Buddy-伙伴系统-还需要slab" class="headerlink" title="1 为什么有了Buddy(伙伴系统)还需要slab?"></a>1 为什么有了Buddy(伙伴系统)还需要slab?</h2><h3 id="1-1-什么是伙伴系统？"><a href="#1-1-什么是伙伴系统？" class="headerlink" title="1.1 什么是伙伴系统？"></a>1.1 什么是伙伴系统？</h3><p>Linux内核中使用伙伴系统（buddy system）算法以页为单位管理内存，进行内存分配。</p>
<h3 id="1-1-1-伙伴系统思想"><a href="#1-1-1-伙伴系统思想" class="headerlink" title="1.1.1 伙伴系统思想"></a>1.1.1 伙伴系统思想</h3><p>它把所有的空闲页放到11个链表中，每个链表分别管理大小为1，2，4，8，16，32，64，128，256，512，1024个页的内存块。当系统需要分配内存时，就可以从buddy系统中获取。</p>
<h3 id="1-2-伙伴系统例子说明"><a href="#1-2-伙伴系统例子说明" class="headerlink" title="1.2 伙伴系统例子说明"></a>1.2 伙伴系统例子说明</h3><p>例如，要申请一块包含4个页的连续内存，就直接从buddy系统中管理4个页连续内存的链表中获取。同样的，如果系统需要申请3个页的连续内存，则只能在4个页的链表中获取，剩下的一个页被放到buddy系统中管理1个页的链表中。</p>
<h3 id="1-3-伙伴系统能解决的问题"><a href="#1-3-伙伴系统能解决的问题" class="headerlink" title="1.3 伙伴系统能解决的问题"></a>1.3 伙伴系统能解决的问题</h3><p>Buddy 系统解决了物理内存分配的外部碎片问题。</p>
<p>Linux内存管理 - buddy系统<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/longchang/p/10749392.html">https://www.cnblogs.com/longchang/p/10749392.html</a></p>
<h2 id="2-为什么需要引入slab算法？"><a href="#2-为什么需要引入slab算法？" class="headerlink" title="2 为什么需要引入slab算法？"></a>2 为什么需要引入slab算法？</h2><h3 id="2-1-伙伴系统的缺点"><a href="#2-1-伙伴系统的缺点" class="headerlink" title="2.1 伙伴系统的缺点"></a>2.1 伙伴系统的缺点</h3><p>Buddy提供了以page为单位的内存分配接口，这对内核来说颗粒度还太大了，所以需要一种新的机制，将page拆分为更小的单位来管理。</p>
<h3 id="2-2-伙伴系统的缺点例子说明"><a href="#2-2-伙伴系统的缺点例子说明" class="headerlink" title="2.2 伙伴系统的缺点例子说明"></a>2.2 伙伴系统的缺点例子说明</h3><p>Linux内存以页为单位进行内存管理，buddy算法以2的n次方个页面来进行内存分配管理，最小为20，也就是一页，最大为211，就是4MB大小的连续内存空间。但是页的粒度还是太大，Linux下是4KB大小，也就是4096个字节，而kernel本身有很多数据结构时时刻刻都需要分配或者释放，这些数据的大小又往往小于4KB大小，一般只有几个几十个字节这样的大小。<br>比方最常用到的task_struct（进程描述符）结构体和mm_struct（内存描述符）结构体，其中，izeof task_struct = 9152,sizeof mm_struct = 2064。</p>
<p>task_struct稍微大一点将近2个页面，mm_struct就只有差不多半个页面了。这样一来如果所有的这些数据结构都按照页来分配存储和管理，那么我相信kernel过不了多久自己就玩完了，内存碎片肯定一堆一堆。</p>
<p>所以，引入slab分配器是为了弥补内存管理粒度太大的不足。</p>
<h2 id="3-slab-能解决什么问题？"><a href="#3-slab-能解决什么问题？" class="headerlink" title="3 slab 能解决什么问题？"></a>3 slab 能解决什么问题？</h2><p>slab分配需要解决的是内存的内部碎片问题。<br>所谓内部碎片就是指被内核分配出去但是不能被利用的内存。<br>而外部碎片是指由于频繁地申请和释放页框而导致的某些小的连续页框，比方只有一个页框，无法分配给需要大的连续页框的进程而导致的内存碎片。</p>
<h3 id="3-0-slab-分配例子"><a href="#3-0-slab-分配例子" class="headerlink" title="3.0 slab 分配例子"></a>3.0 slab 分配例子</h3><p>比如我需要一个100字节的连续物理内存，那么内核slab分配器会给我提供一个相应大小的连续物理内存单元，为128字节大小(不会是整好100字节，而是这个档的一个对齐值，如100字节对应128字节，30字节对应32字节，60字节对应64字节)</p>
<h2 id="4-slab系统核心思想是什么？"><a href="#4-slab系统核心思想是什么？" class="headerlink" title="4 slab系统核心思想是什么？"></a>4 slab系统核心思想是什么？</h2><h3 id="4-0-须知："><a href="#4-0-须知：" class="headerlink" title="4.0. 须知："></a>4.0. 须知：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache： 内存池</span><br><span class="line">slab：       内存池从系统申请内存的基本单位</span><br><span class="line">object：     内存池提供的内存的单位</span><br></pre></td></tr></table></figure>

<h3 id="4-1-slab核心思想：对象管理内存（简单说：就是你经常用什么我先给你创造一堆出来，你要用直接拿，不用放回来）"><a href="#4-1-slab核心思想：对象管理内存（简单说：就是你经常用什么我先给你创造一堆出来，你要用直接拿，不用放回来）" class="headerlink" title="4.1 slab核心思想：对象管理内存（简单说：就是你经常用什么我先给你创造一堆出来，你要用直接拿，不用放回来）"></a>4.1 slab核心思想：对象管理内存（简单说：就是你经常用什么我先给你创造一堆出来，你要用直接拿，不用放回来）</h3><p>使用对象的概念来管理内存。</p>
<p>slab分配器的基本思想是，先利用页面分配器分配出单个或者一组连续的物理页面，然后在此基础上将整块页面分割成多个相等的小内存单元，以满足小内存空间分配的需要。当然，为了有效的管理这些小的内存单元并保证极高的内存使用速度和效率。</p>
<p>这段话摘自：《深入linux设备驱动程序内核机制》<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yuzhihui_no1/article/details/47305361">https://blog.csdn.net/yuzhihui_no1/article/details/47305361</a></p>
<h3 id="4-2-slab的对象-内存池思想"><a href="#4-2-slab的对象-内存池思想" class="headerlink" title="4.2 slab的对象/内存池思想"></a>4.2 slab的对象/内存池思想</h3><p>在内核中，经常会使用一些链表，链表中会申请许多相同结构的结构体，比如文件对象，进程对象等等，如果申请比较频繁，那么为它们建立一个内存池，内存池中都是相同结构的结构体，当想申请这种结构体时，直接从这种内存池中取一个结构体出来，是有用且速度极快的。一个物理页就可以作用这种内存池的载体，进而进行充分利用，减少了内部碎片的产生。</p>
<p>所以，Slab 相当于内存池思想，且是为了解决内碎片而产生的，slab的核心思想是以对象的观点管理内存。</p>
<h3 id="4-3-slab中对象是什么？"><a href="#4-3-slab中对象是什么？" class="headerlink" title="4.3 slab中对象是什么？"></a>4.3 slab中对象是什么？</h3><p>所谓的对象就是存放一组数据结构的内存区，为便于理解可把对象看作内核中的数据结构（例如：task_struct,file_struct 等）。</p>
<p>相同类型的对象归为一类，每当要申请这样一个对象时，slab分配器就从一个slab列表中分配一个这样大小的单元出去，而当要释放时，将其重新保存在该列表中，而不是直接返回给伙伴系统，从而避免内部碎片。</p>
<h3 id="4-4-cache是内存中的区域，而不是指硬件高速缓存"><a href="#4-4-cache是内存中的区域，而不是指硬件高速缓存" class="headerlink" title="4.4 cache是内存中的区域，而不是指硬件高速缓存"></a>4.4 cache是内存中的区域，而不是指硬件高速缓存</h3><p>这种场景是非常多的，为了应对这种场景，slab为这样的对象创建一个cache，即缓存。每个cache所占的内存区又被划分多个slab，每个 slab是由一个或多个连续的页框组成。每个页框中包含若干个对象，既有已经分配的对象，也包含空闲的对象。</p>
<p>尽管英文中使用了Cache这个词，但实际上指的是内存中的区域，而不是指硬件高速缓存</p>
<h3 id="4-5-slab分配器的一个基本原则"><a href="#4-5-slab分配器的一个基本原则" class="headerlink" title="4.5 slab分配器的一个基本原则"></a>4.5 slab分配器的一个基本原则</h3><p>slab分配器对不同长度内存是分档的，这是slab分配器的一个基本原则，按申请的内存的大小分配相应长度的内存。</p>
<p>这可以先参考kmalloc的实现，kmalloc申请的物理内存长度为参数size，它需要先根据这个长度找到相应的长度的缓存<br>slab分配器并非一开始就能智能的根据内存分档值分配相应长度的内存。每种cache对应一种长度的slab分配。</p>
<h2 id="5-slab分配的最小和最大内存单元是多少"><a href="#5-slab分配的最小和最大内存单元是多少" class="headerlink" title="5 slab分配的最小和最大内存单元是多少?"></a>5 slab分配的最小和最大内存单元是多少?</h2><p>23、………211个字节。<br>另外还有两个特殊的组，分别是96B和192B，共11组</p>
<p>所以，slab分配内存大小是：<br>8B，16B，32B，64B，96B，128B，192B，256B，512B，1024B，2048B等大小。共11组</p>
<h3 id="5-1-cat-proc-slabinfo-查看系统中的slab对象"><a href="#5-1-cat-proc-slabinfo-查看系统中的slab对象" class="headerlink" title="5.1 cat /proc/slabinfo 查看系统中的slab对象"></a>5.1 cat /proc/slabinfo 查看系统中的slab对象</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 10]# cat /proc/slabinfo</span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">name  &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;<span class="built_in">limit</span>&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span></span><br><span class="line"></span><br><span class="line">rpc_inode_cache       51     51    640   51    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">xfs_dqtrx              0      0    528   62    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">xfs_dquot              0      0    488   67    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">xfs_ili             2160   2160    168   48    2 : tunables    0    0    0 : slabdata     45     45      0</span><br><span class="line">xfs_inode          21352  21352    960   34    8 : tunables    0    0    0 : slabdata    628    628      0</span><br><span class="line">xfs_efd_item         156    156    416   39    4 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">xfs_btree_cur         39     39    208   39    2 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">xfs_log_ticket        44     44    184   44    2 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">bio-2                 51     51    320   51    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">kcopyd_job             0      0   3312    9    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dm_uevent              0      0   2608   12    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dm_rq_target_io        0      0    136   60    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">ip6_dst_cache         72     72    448   36    4 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">RAWv6                286    286   1216   26    8 : tunables    0    0    0 : slabdata     11     11      0</span><br><span class="line">UDPLITEv6              0      0   1216   26    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">UDPv6                 26     26   1216   26    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">tw_sock_TCPv6          0      0    256   64    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">TCPv6                 15     15   2176   15    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">cfq_queue             70     70    232   70    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">bsg_cmd                0      0    312   52    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">mqueue_inode_cache    36     36    896   36    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">hugetlbfs_inode_cache 53     53    608   53    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">configfs_dir_cache     0      0     88   46    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dquot                  0      0    256   64    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">userfaultfd_ctx_cache  0      0    192   42    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">fanotify_event_info   73     73     56   73    1 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">pid_namespace          0      0   2200   14    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">posix_timers_cache    66     66    248   66    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">UDP-Lite               0      0   1088   30    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">flow_cache             0      0    144   56    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">xfrm_dst_cache         0      0    576   56    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">UDP                   30     30   1088   30    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">tw_sock_TCP            0      0    256   64    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">TCP                   16     16   1984   16    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">dax_cache             42     42    768   42    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">blkdev_queue          26     26   2424   13    8 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">blkdev_ioc            78     78    104   39    1 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">user_namespace        68     68    480   68    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">dmaengine-unmap-128     30     30   1088   30    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">sock_inode_cache    1020   1020    640   51    8 : tunables    0    0    0 : slabdata     20     20      0</span><br><span class="line">fsnotify_mark_connector 129370 129370     24  170    1 : tunables    0    0    0 : slabdata    761    761      0</span><br><span class="line">net_namespace          6      6   5248    6    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">shmem_inode_cache   1200   1200    680   48    8 : tunables    0    0    0 : slabdata     25     25      0</span><br><span class="line">Acpi-ParseExt       6440   6440     72   56    1 : tunables    0    0    0 : slabdata    115    115      0</span><br><span class="line">Acpi-State           102    102     80   51    1 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">task_delay_info      288    288    112   36    1 : tunables    0    0    0 : slabdata      8      8      0</span><br><span class="line">taskstats             49     49    328   49    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">proc_inode_cache    1621   1813    656   49    8 : tunables    0    0    0 : slabdata     37     37      0</span><br><span class="line">sigqueue              51     51    160   51    2 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">bdev_cache            39     39    832   39    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">kernfs_node_cache  35360  35360    120   68    2 : tunables    0    0    0 : slabdata    520    520      0</span><br><span class="line">mnt_cache           2478   2478    384   42    4 : tunables    0    0    0 : slabdata     59     59      0</span><br><span class="line">inode_cache        16720  16720    592   55    8 : tunables    0    0    0 : slabdata    304    304      0</span><br><span class="line">dentry             49350  49350    192   42    2 : tunables    0    0    0 : slabdata   1175   1175      0</span><br><span class="line">iint_cache             0      0    128   64    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">selinux_inode_security  45798  45798     40  102    1 : tunables    0    0    0 : slabdata    449    449      0</span><br><span class="line">buffer_head         2145   2145    104   39    1 : tunables    0    0    0 : slabdata     55     55      0</span><br><span class="line">vm_area_struct      4699   4699    216   37    2 : tunables    0    0    0 : slabdata    127    127      0</span><br><span class="line">mm_struct             60     60   1600   20    8 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">files_cache          204    204    640   51    8 : tunables    0    0    0 : slabdata      4      4      0</span><br><span class="line">signal_cache         252    252   1152   28    8 : tunables    0    0    0 : slabdata      9      9      0</span><br><span class="line">sighand_cache        255    255   2112   15    8 : tunables    0    0    0 : slabdata     17     17      0</span><br><span class="line">task_xstate          273    273    832   39    8 : tunables    0    0    0 : slabdata      7      7      0</span><br><span class="line">task_struct          255    264   4048    8    8 : tunables    0    0    0 : slabdata     33     33      0</span><br><span class="line">anon_vma            1887   1887     80   51    1 : tunables    0    0    0 : slabdata     37     37      0</span><br><span class="line">shared_policy_node   2635   2635     48   85    1 : tunables    0    0    0 : slabdata     31     31      0</span><br><span class="line">numa_policy          186    186    264   62    4 : tunables    0    0    0 : slabdata      3      3      0</span><br><span class="line">radix_tree_node     2856   2856    584   56    8 : tunables    0    0    0 : slabdata     51     51      0</span><br><span class="line">idr_layer_cache      180    180   2112   15    8 : tunables    0    0    0 : slabdata     12     12      0</span><br><span class="line">dma-kmalloc-8192       0      0   8192    4    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-4096       0      0   4096    8    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-2048       0      0   2048   16    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-1024       0      0   1024   32    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-512       64     64    512   64    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">dma-kmalloc-256        0      0    256   64    4 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-128        0      0    128   64    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-64         0      0     64   64    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-32         0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-16         0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-8          0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-192        0      0    192   42    2 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">dma-kmalloc-96         0      0     96   42    1 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">kmalloc-8192          40     40   8192    4    8 : tunables    0    0    0 : slabdata     10     10      0</span><br><span class="line">kmalloc-4096         254    264   4096    8    8 : tunables    0    0    0 : slabdata     33     33      0</span><br><span class="line">kmalloc-2048         955   1072   2048   16    8 : tunables    0    0    0 : slabdata     67     67      0</span><br><span class="line">kmalloc-1024        2894   2976   1024   32    8 : tunables    0    0    0 : slabdata     93     93      0</span><br><span class="line">kmalloc-512         4825   4864    512   64    8 : tunables    0    0    0 : slabdata     76     76      0</span><br><span class="line">kmalloc-256         7406   7552    256   64    4 : tunables    0    0    0 : slabdata    118    118      0</span><br><span class="line">kmalloc-192         7560   7560    192   42    2 : tunables    0    0    0 : slabdata    180    180      0</span><br><span class="line">kmalloc-128         3136   3136    128   64    2 : tunables    0    0    0 : slabdata     49     49      0</span><br><span class="line">kmalloc-96          5334   5334     96   42    1 : tunables    0    0    0 : slabdata    127    127      0</span><br><span class="line">kmalloc-64         84850  85184     64   64    1 : tunables    0    0    0 : slabdata   1331   1331      0</span><br><span class="line">kmalloc-32        125696 125696     32  128    1 : tunables    0    0    0 : slabdata    982    982      0</span><br><span class="line">kmalloc-16         63232  63232     16  256    1 : tunables    0    0    0 : slabdata    247    247      0</span><br><span class="line">kmalloc-8          86528  86528      8  512    1 : tunables    0    0    0 : slabdata    169    169      0</span><br><span class="line">kmem_cache_node      128    128     64   64    1 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">kmem_cache           128    128    256   64    4 : tunables    0    0    0 : slabdata      2      2      0</span><br><span class="line">[root@localhost 10]#</span><br></pre></td></tr></table></figure>

<h2 id="6-slab与buddy系统的关系"><a href="#6-slab与buddy系统的关系" class="headerlink" title="6 slab与buddy系统的关系"></a>6 slab与buddy系统的关系</h2><h3 id="6-1-互补的"><a href="#6-1-互补的" class="headerlink" title="6.1 互补的"></a>6.1 互补的</h3><p>slab系统与buddy系统所要解决的问题是互补的，一个解决外部碎片一个解决内部碎片，但事实上，slab在新建cache时同样需要用到buddy来为之分配页面，而在释放cache时也需要buddy来回收这此页面。也就是说，slab事实上是依赖buddy系统的。</p>
<h3 id="6-2-实际还是伙伴系统分配物理页"><a href="#6-2-实际还是伙伴系统分配物理页" class="headerlink" title="6.2 实际还是伙伴系统分配物理页"></a>6.2 实际还是伙伴系统分配物理页</h3><p>从slab的分配可以知道，其实所有的内存最终还是要伙伴系统来分配，这里就可以知道，这些内存都是连续的物理页。</p>
<h3 id="6-3-slab作为内核缓存对象"><a href="#6-3-slab作为内核缓存对象" class="headerlink" title="6.3 slab作为内核缓存对象"></a>6.3 slab作为内核缓存对象</h3><p>在某些情况下内核模块可能需要频繁的分配和释放相同的内存对象，这时候slab可以作为内核对象的缓存，当slab对象被释放时，slab分配器并不会把对象占用的物理空间还给伙伴系统。这样的好处是当内核模块需要再次分配内存对象时，不需要那么麻烦的向伙伴系统申请，而是可以直接在slab链表中分配一个合适的对象</p>
<h2 id="7-slab-配器结构"><a href="#7-slab-配器结构" class="headerlink" title="7 slab 配器结构"></a>7 slab 配器结构</h2><h3 id="7-1-slab-结构图"><a href="#7-1-slab-结构图" class="headerlink" title="7.1 slab 结构图"></a>7.1 slab 结构图</h3><p>图：</p>
<p><img src="/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/image-20221012160254149.png" alt="image-20221012160254149"></p>
<p>解释：<br>每个kmem_cache都是链接在一起形成一个全局的双向链表，由cache指向该链表，系统可以从Cache_chain开始扫描每个kmem_cache，来找到一个大小最合适的kmem_cache，然后从该kmem_cache中分配一个对象</p>
<h3 id="7-2-slab-结构解释"><a href="#7-2-slab-结构解释" class="headerlink" title="7.2 slab 结构解释"></a>7.2 slab 结构解释</h3><h3 id="7-2-1-cache-chain"><a href="#7-2-1-cache-chain" class="headerlink" title="7.2.1 cache_chain"></a>7.2.1 cache_chain</h3><p>最高层是 cache_chain,这是一个 slab 缓存的链接列表。可以用来查找最适合所需要的分配大小的缓存（遍历列表）<br>cache_chain 的每个元素都是一个 kmem_cache 结构的引用（称为一个 cache）。它定义了一个要管理的给定大小的对象池。</p>
<h3 id="7-2-2-kmem-cache"><a href="#7-2-2-kmem-cache" class="headerlink" title="7.2.2 kmem_cache"></a>7.2.2 kmem_cache</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kmem_cache： 内存池</span><br><span class="line">slab：       内存池从系统申请内存的基本单位</span><br><span class="line">object：     内存池提供的内存的单位</span><br></pre></td></tr></table></figure>

<h3 id="7-2-2-1-kmem-cache-或-cache："><a href="#7-2-2-1-kmem-cache-或-cache：" class="headerlink" title="7.2.2.1 kmem_cache 或 cache："></a>7.2.2.1 kmem_cache 或 cache：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">有的地方也会叫这个kmem_cache为cache，原因是kmem_cache中的object有大有小（其实也是kmem_cache有大有小），</span><br><span class="line">当内存申请时，会有命中该kmem_cache的说法，和CPU中的cache命中是类似的意思，所以也会叫kmem_cache为cache</span><br></pre></td></tr></table></figure>

<h3 id="7-2-2-2-三条链表：slabs-full-slabs-partial-slabs-empty"><a href="#7-2-2-2-三条链表：slabs-full-slabs-partial-slabs-empty" class="headerlink" title="7.2.2.2 三条链表：slabs_full slabs_partial slabs_empty"></a>7.2.2.2 三条链表：slabs_full slabs_partial slabs_empty</h3><p>每个缓存(kmem_cache)都包含了一个 slabs 列表，这是一段连续的内存块（通常都是页面）<br>其中每个kmem_cache有三条链表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slabs_full 表示该链表中每个slab的object对象都已经分配完了</span><br><span class="line">slabs_partial 表示该链表中的slab的object对象部分分配完了</span><br><span class="line">slabs_empty  表示该链表中的object对象全部没有分配出去（空 slab，未分配）</span><br></pre></td></tr></table></figure>


<p>对象的分配和释放都是在slab中进行的，所以slab可以在三条链表中移动，如果slab中的object都分配完了，则会移到full 链表中；如果分配了一部分object，则会移到partial链表中；如果所有object都释放了，则会移动到empty链表中；其中当系统内存紧张的时候，slabs_empty链表中的slab可能会被返回给系统。</p>
<h4 id="7-2-2-3-cache-cache-结构体等说明"><a href="#7-2-2-3-cache-cache-结构体等说明" class="headerlink" title="7.2.2.3 cache_cache 结构体等说明"></a>7.2.2.3 cache_cache 结构体等说明</h4><p>所有的kmem_cache结构都是从cache_cache分配的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">kmem_cache_t</span> cache_cache = &#123;</span><br><span class="line">     slabs_full:     LIST_HEAD_INIT(cache_cache.slabs_full),</span><br><span class="line">     slabs_partial:  LIST_HEAD_INIT(cache_cache.slabs_partial),</span><br><span class="line">     slabs_free:     LIST_HEAD_INIT(cache_cache.slabs_free),</span><br><span class="line">     objsize:        <span class="keyword">sizeof</span>(<span class="type">kmem_cache_t</span>),</span><br><span class="line">     flags:          SLAB_NO_REAP,</span><br><span class="line">     spinlock:       SPIN_LOCK_UNLOCKED,</span><br><span class="line">     colour_off:     L1_CACHE_BYTES,</span><br><span class="line">     name:           <span class="string">&quot;kmem_cache&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_size</span>&#123;</span></span><br><span class="line">	<span class="type">size_t</span> cs_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cs_cachep</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_size</span> <span class="title">malloc_sizes</span>[] =</span> &#123; </span><br><span class="line">	&#123;.cs_size = <span class="number">32</span>&#125;,</span><br><span class="line">	&#123;.cs_size = <span class="number">64</span>&#125;,</span><br><span class="line">	&#123;.cs_size = <span class="number">128</span>&#125;,</span><br><span class="line">	&#123;.cs_size = <span class="number">256</span>&#125;,</span><br><span class="line">	................</span><br><span class="line">	&#123;.cs_size = ~<span class="number">0UL</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在系统初始化时，内核会调用kmem_cache_init函数对malloc_size数组进行遍历，对数组中的每个元素都调用kmem_cache_create()函数在cache_cache中分配一个struct kmem_cache 实例，并且把kmem_cache所在的地址赋值给cache_size中的cs_cachep指针</p>
<h3 id="7-2-3-slab"><a href="#7-2-3-slab" class="headerlink" title="7.2.3 slab"></a>7.2.3 slab</h3><p>slab 列表中的每个 slab 都是一个连续的内存块（一个或多个连续页），它们被划分成一个个对象（如 mm_struct）。<br>这些对象是从特定缓存中进行分配和释放的基本元素。</p>
<h2 id="8-slab-和-proc"><a href="#8-slab-和-proc" class="headerlink" title="8 slab 和 /proc"></a>8 slab 和 /proc</h2><p>proc 文件系统提供了一种简单的方法来监视系统中所有活动的 slab 缓存。<br>这个文件称为 /proc/slabinfo，<br>它除了提供一些可以从用户空间访问的可调整参数之外，还提供了有关所有 slab 缓存的详细信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost home]# cat  /proc/slabinfo</span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;<span class="built_in">limit</span>&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span></span><br><span class="line">nf_conntrack_ffffffffb58fc900     51     51    320   51    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">rpc_inode_cache       51     51    640   51    8 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">xfs_dqtrx              0      0    528   62    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">xfs_dquot              0      0    488   67    8 : tunables    0    0    0 : slabdata      0      0      0</span><br><span class="line">xfs_ili             2016   2016    168   48    2 : tunables    0    0    0 : slabdata     42     42      0</span><br><span class="line">xfs_inode          21182  21182    960   34    8 : tunables    0    0    0 : slabdata    623    623      0</span><br><span class="line">xfs_efd_item          39     39    416   39    4 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">xfs_btree_cur         39     39    208   39    2 : tunables    0    0    0 : slabdata      1      1      0</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h2 id="9-slab-API"><a href="#9-slab-API" class="headerlink" title="9 slab API"></a>9 slab API</h2><p>Linux内存管理之slab 2：slab API<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lqy971966/article/details/119801912">https://blog.csdn.net/lqy971966/article/details/119801912</a></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yuzhihui_no1/article/details/47305361">https://blog.csdn.net/yuzhihui_no1/article/details/47305361</a></p>
<p><strong>转载于：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lqy971966/article/details/112980005">https://blog.csdn.net/lqy971966/article/details/112980005</a></strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/10/12/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-slab%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Abuddy%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/" data-id="cl95cpvup0000ugmj5yiydakw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/10/18/%E5%9F%BA%E4%BA%8Eriscv%E4%BD%BF%E7%94%A8%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          基于riscv使用汇编实现简单的任务调度
        
      </div>
    </a>
  
  
    <a href="/2022/10/11/go%E8%AF%AD%E8%A8%80%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">go语言协程调度原理</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/11/03/spike%E7%9B%B8%E5%85%B3%E7%90%86%E8%A7%A31/">spike相关理解1</a>
          </li>
        
          <li>
            <a href="/2022/11/02/qemu%E6%96%B0%E5%A2%9ESoc/">qemu新增Soc</a>
          </li>
        
          <li>
            <a href="/2022/10/28/rtos%E4%B8%AD%E6%96%AD%E6%B5%81%E7%A8%8B/">rtos中断流程</a>
          </li>
        
          <li>
            <a href="/2022/10/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BD%8D%E5%9B%BE/">数据结构位图</a>
          </li>
        
          <li>
            <a href="/2022/10/21/riscv%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B/">riscv汇编语言编程</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>